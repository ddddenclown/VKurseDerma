<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VKurseDerma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #007bff;
            color: white;
            padding: 10px 0;
        }
        nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
        }
        nav ul li {
            margin: 0 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
        }
        nav ul li a:hover {
            text-decoration: underline;
        }
        main {
            padding: 20px;
            min-height: 80vh;
        }
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px 0;
            position: relative;
            bottom: 0;
            width: 100%;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="#home" onclick="showSection('home')">Главная</a></li>
                <li><a href="#profile" onclick="showSection('profile')">Профиль</a></li>
                <li><a href="#friends" onclick="showSection('friends')">Друзья</a></li>
                <li><a href="#users" onclick="showSection('users')">Пользователи</a></li>
                <li><a href="#posts" onclick="showSection('posts')">Посты</a></li>
                <li><a href="#chats" onclick="showSection('chats')">Чаты</a></li>
                <li><a href="#login" onclick="showSection('login')">Вход</a></li>
                <li><a href="#register" onclick="showSection('register')">Регистрация</a></li>
            </ul>
        </nav>
    </header>
    <main id="content">
        <div id="home" class="content-section active">
            <h2>Добро пожаловать в VKurseDerma</h2>
            <p>Это социальная сеть для общения и обмена информацией.</p>
        </div>
        <div id="profile" class="content-section">
            <h2>Профиль</h2>
            <div id="profile-info"></div>
            <button class="btn btn-primary" onclick="loadProfile()">Обновить профиль</button>
        </div>
        <div id="friends" class="content-section">
            <h2>Друзья</h2>
            <div id="friends-list"></div>
            <button class="btn btn-primary" onclick="loadFriends()">Обновить список друзей</button>
        </div>
        <div id="users" class="content-section">
            <h2>Пользователи</h2>
            <input type="text" id="user-search" class="form-control" placeholder="Поиск пользователей">
            <button class="btn btn-primary mt-2" onclick="searchUsers()">Поиск</button>
            <div id="users-list"></div>
        </div>
        <div id="posts" class="content-section">
            <h2>Посты</h2>
            <div id="posts-list"></div>
            <button class="btn btn-primary" onclick="loadPosts()">Обновить посты</button>
            <div class="mt-3">
                <input type="text" id="post-title" class="form-control" placeholder="Заголовок поста">
                <textarea id="post-content" class="form-control mt-2" placeholder="Содержание поста"></textarea>
                <button class="btn btn-success mt-2" onclick="createPost()">Создать пост</button>
            </div>
        </div>
        <div id="chats" class="content-section">
            <h2>Чаты</h2>
            <div id="conversations-list"></div>
            <button class="btn btn-primary" onclick="loadConversations()">Обновить беседы</button>
        </div>
        <div id="login" class="content-section">
            <h2>Вход</h2>
            <input type="text" id="login-username" class="form-control" placeholder="Имя пользователя">
            <input type="password" id="login-password" class="form-control mt-2" placeholder="Пароль">
            <button class="btn btn-primary mt-2" onclick="handleLogin()">Войти</button>
        </div>
        <div id="register" class="content-section">
            <h2>Регистрация</h2>
            <input type="text" id="reg-username" class="form-control" placeholder="Имя пользователя">
            <input type="email" id="reg-email" class="form-control mt-2" placeholder="Email">
            <input type="text" id="reg-fullname" class="form-control mt-2" placeholder="Полное имя">
            <input type="password" id="reg-password" class="form-control mt-2" placeholder="Пароль">
            <button class="btn btn-primary mt-2" onclick="handleRegister()">Зарегистрироваться</button>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 VKurseDerma</p>
    </footer>
    <script>
        const API_URL = 'http://localhost:8000/api/v1';

        // Показать секцию
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // Универсальная функция для запросов к API
        async function fetchData(endpoint, method = 'GET', body = null, token = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (!response.ok) throw new Error(`Ошибка: ${response.status}`);
            return response.json();
        }

        // Регистрация
        async function handleRegister() {
            const userData = {
                username: document.getElementById('reg-username').value,
                email: document.getElementById('reg-email').value,
                full_name: document.getElementById('reg-fullname').value,
                password: document.getElementById('reg-password').value
            };
            try {
                await fetchData('/auth/register', 'POST', userData);
                alert('Регистрация успешна! Теперь войдите.');
                showSection('login');
            } catch (error) {
                alert('Ошибка регистрации: ' + error.message);
            }
        }

        // Вход
        async function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                if (!response.ok) throw new Error(`Ошибка: ${response.status}`);
                const data = await response.json();
                localStorage.setItem('token', data.access_token);
                alert('Вход успешен!');
                showSection('profile');
                loadProfile();
            } catch (error) {
                alert('Ошибка входа: ' + error.message);
            }
        }

        // Загрузка профиля
        async function loadProfile() {
            const token = localStorage.getItem('token');
            try {
                const profile = await fetchData('/profile/', 'GET', null, token);
                document.getElementById('profile-info').innerHTML = `
                    <p><strong>Полное имя:</strong> ${profile.full_name || 'Не указано'}</p>
                    <p><strong>Биография:</strong> ${profile.bio || 'Не указано'}</p>
                    <p><strong>Аватар:</strong> <img src="${profile.avatar_url || ''}" alt="Аватар" width="100"></p>
                `;
            } catch (error) {
                alert('Ошибка загрузки профиля: ' + error.message);
            }
        }

        // Загрузка списка друзей
        async function loadFriends() {
            const token = localStorage.getItem('token');
            try {
                const data = await fetchData('/friends/me', 'GET', null, token);
                const friendsList = data.friends.map(friend => `<li>${friend.username}</li>`).join('');
                document.getElementById('friends-list').innerHTML = `<ul>${friendsList}</ul>`;
            } catch (error) {
                alert('Ошибка загрузки друзей: ' + error.message);
            }
        }

        // Поиск пользователей
        async function searchUsers() {
            const token = localStorage.getItem('token');
            const query = document.getElementById('user-search').value;
            try {
                const users = await fetchData(`/users/search?query=${query}`, 'GET', null, token);
                const usersList = users.map(user => `<li>${user.username} (${user.email})</li>`).join('');
                document.getElementById('users-list').innerHTML = `<ul>${usersList}</ul>`;
            } catch (error) {
                alert('Ошибка поиска пользователей: ' + error.message);
            }
        }

        // Создание поста
        async function createPost() {
            const token = localStorage.getItem('token');
            const postData = {
                title: document.getElementById('post-title').value,
                content: document.getElementById('post-content').value
            };
            try {
                await fetchData('/posts/', 'POST', postData, token);
                alert('Пост создан!');
                loadPosts();
            } catch (error) {
                alert('Ошибка создания поста: ' + error.message);
            }
        }

        // Загрузка постов
        async function loadPosts() {
            const token = localStorage.getItem('token');
            try {
                const posts = await fetchData('/posts/me', 'GET', null, token);
                const postsList = posts.map(post => `
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="card-title">${post.title}</h5>
                            <p class="card-text">${post.content}</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('posts-list').innerHTML = postsList;
            } catch (error) {
                alert('Ошибка загрузки постов: ' + error.message);
            }
        }

        // Загрузка бесед
        async function loadConversations() {
            const token = localStorage.getItem('token');
            try {
                const conversations = await fetchData('/chats/conversations/', 'GET', null, token);
                const convList = conversations.map(conv => `
                    <li>Беседа #${conv.id} (Участники: ${conv.participants.join(', ')})</li>
                `).join('');
                document.getElementById('conversations-list').innerHTML = `<ul>${convList}</ul>`;
            } catch (error) {
                alert('Ошибка загрузки бесед: ' + error.message);
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            showSection('home');
        });
    </script>
</body>
</html>