<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VKurseDerma</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .tab { display: none; }
    .active { display: block; }
    nav { margin: 10px 0; }
    button { margin: 5px; padding: 8px 12px; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
    ul { list-style: none; padding: 0; }
    li { padding: 8px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <!-- –í–∫–ª–∞–¥–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="auth-tab" class="tab active">
    <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <form id="login-form">
      <input type="text" id="login-username" placeholder="–õ–æ–≥–∏–Ω" required>
      <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <button type="submit">–í–æ–π—Ç–∏</button>
    </form>
    <button id="show-register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="register-tab" class="tab">
    <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <form id="register-form">
      <input type="text" id="reg-username" placeholder="–õ–æ–≥–∏–Ω" required>
      <input type="email" id="reg-email" placeholder="Email" required>
      <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>
    <button id="show-login">–ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <div id="app-tab" class="tab">
    <button id="logout-btn">–í—ã–π—Ç–∏</button>
    <nav>
      <button onclick="showAppTab('profile-tab')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
      <button onclick="showAppTab('users-tab')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      <button onclick="showAppTab('friends-tab')">ü§ù –î—Ä—É–∑—å—è</button>
    </nav>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profile-tab" class="app-tab">
      <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
      <div id="profile-view"></div>
      <form id="profile-edit-form" style="display: none;">
        <input type="text" id="edit-full-name" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è">
        <textarea id="edit-bio" placeholder="–û —Å–µ–±–µ"></textarea>
        <input type="text" id="edit-avatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞">
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
      <button id="edit-profile-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="users-tab" class="app-tab active">
      <h2>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <form id="search-form">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É...">
        <button type="submit">üîç –ò—Å–∫–∞—Ç—å</button>
        <button type="button" id="reset-button">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
      </form>
      <ul id="users-list"></ul>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –¥—Ä—É–∑–µ–π -->
    <div id="friends-tab" class="app-tab">
      <h2>ü§ù –ú–æ–∏ –¥—Ä—É–∑—å—è</h2>
      <h3>–î—Ä—É–∑—å—è</h3>
      <ul id="friends-list"></ul>
      <h3>–ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è</h3>
      <ul id="requests-list"></ul>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8000/api/v1";
    let token = localStorage.getItem('token');
    let currentUser = null;

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏
    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    function showAppTab(tabId) {
      document.querySelectorAll('.app-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');

        const data = await response.json();
        token = data.access_token;
        localStorage.setItem('token', token);
        currentUser = { id: data.user_id, username: data.username };

        showTab('app-tab');
        showAppTab('users-tab');
        fetchUsers();
      } catch (error) {
        alert(error.message);
      }
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = {
        username: document.getElementById('reg-username').value,
        email: document.getElementById('reg-email').value,
        password: document.getElementById('reg-password').value
      };

      try {
        const response = await fetch(`${API_BASE}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(user)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        }

        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
        showTab('auth-tab');
      } catch (error) {
        alert(error.message);
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    async function fetchUsers(query = '') {
      try {
        const url = query
          ? `${API_BASE}/users/search?query=${encodeURIComponent(query)}`
          : `${API_BASE}/users/`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
        const users = await response.json();

        const list = document.getElementById('users-list');
        list.innerHTML = '';

        if (users.length === 0) {
          list.innerHTML = '<li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</li>';
          return;
        }

        users.forEach(user => {
          const li = document.createElement('li');
          li.innerHTML = `
            <strong>${user.username}</strong> (${user.email})
            <button onclick="sendFriendRequest(${user.id})">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        document.getElementById('users-list').innerHTML = `<li>–û—à–∏–±–∫–∞: ${error.message}</li>`;
      }
    }

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    document.getElementById('search-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const query = document.getElementById('search-input').value;
      fetchUsers(query);
    });

    // –°–±—Ä–æ—Å –ø–æ–∏—Å–∫–∞
    document.getElementById('reset-button').addEventListener('click', () => {
      document.getElementById('search-input').value = '';
      fetchUsers();
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è
    window.sendFriendRequest = async (friendId) => {
      try {
        const response = await fetch(`${API_BASE}/friends/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ friend_id: friendId })
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏');
        alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        loadFriends();
      } catch (error) {
        alert(error.message);
      }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
    async function loadProfile() {
      try {
        const response = await fetch(`${API_BASE}/profile/`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
        const profile = await response.json();

        document.getElementById('profile-view').innerHTML = `
          <p><strong>–ò–º—è:</strong> ${profile.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
          <p><strong>–û —Å–µ–±–µ:</strong> ${profile.bio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
          ${profile.avatar_url ? `<img src="${profile.avatar_url}" width="100">` : ''}
        `;

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('edit-full-name').value = profile.full_name || '';
        document.getElementById('edit-bio').value = profile.bio || '';
        document.getElementById('edit-avatar').value = profile.avatar_url || '';
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
        document.getElementById('profile-view').innerHTML = `<p>–û—à–∏–±–∫–∞: ${error.message}</p>`;
      }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('edit-profile-btn').addEventListener('click', () => {
      document.getElementById('profile-view').style.display = 'none';
      document.getElementById('profile-edit-form').style.display = 'block';
    });

    document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const profileData = {
        full_name: document.getElementById('edit-full-name').value,
        bio: document.getElementById('edit-bio').value,
        avatar_url: document.getElementById('edit-avatar').value
      };

      try {
        const response = await fetch(`${API_BASE}/profile/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(profileData)
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');

        document.getElementById('profile-view').style.display = 'block';
        document.getElementById('profile-edit-form').style.display = 'none';
        loadProfile();
      } catch (error) {
        alert(error.message);
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π
    async function loadFriends() {
      try {
        const response = await fetch(`${API_BASE}/friends/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π');
        const data = await response.json();

        // –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
        const friendsList = document.getElementById('friends-list');
        friendsList.innerHTML = '';

        if (data.friends.length === 0) {
          friendsList.innerHTML = '<li>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</li>';
        } else {
          data.friends.forEach(friend => {
            const li = document.createElement('li');
            li.textContent = friend.username;
            friendsList.appendChild(li);
          });
        }

        // –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏
        const requestsList = document.getElementById('requests-list');
        requestsList.innerHTML = '';

        if (data.pending_requests.length === 0) {
          requestsList.innerHTML = '<li>–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫</li>';
        } else {
          data.pending_requests.forEach(request => {
            const li = document.createElement('li');
            li.innerHTML = `
              ${request.username}
              <button onclick="acceptFriendRequest(${request.id})">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
            `;
            requestsList.appendChild(li);
          });
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error);
      }
    }

    // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è
    window.acceptFriendRequest = async (friendId) => {
      try {
        // –ù–∞–π–¥–µ–º ID –∑–∞—è–≤–∫–∏
        const response = await fetch(`${API_BASE}/friends/status/${friendId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–∞—è–≤–∫–∏');
        const friendship = await response.json();

        // –ü—Ä–∏–º–µ–º –∑–∞—è–≤–∫—É
        const updateResponse = await fetch(`${API_BASE}/friends/${friendship.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status: 'accepted' })
        });

        if (!updateResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏');
        alert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
        loadFriends();
      } catch (error) {
        alert(error.message);
      }
    };

    // –í—ã—Ö–æ–¥
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('token');
      token = null;
      currentUser = null;
      showTab('auth-tab');
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    document.getElementById('show-register').addEventListener('click', () => showTab('register-tab'));
    document.getElementById('show-login').addEventListener('click', () => showTab('auth-tab'));

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if (token) {
      showTab('app-tab');
      showAppTab('users-tab');
      fetchUsers();
    } else {
      showTab('auth-tab');
    }
  </script>
</body>
</html>